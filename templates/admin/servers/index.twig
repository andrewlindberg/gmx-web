{% extends 'admin/admin.twig' %}

{% import 'macros/admin.twig' as admin %}
{% import 'macros/paginator.twig' as paginator %}

{% block content %}
	<a href="{{ path_for('admin_servers_create') }}" class="uk-button uk-button-primary uk-width-1-3 uk-margin uk-margin-top">
		{{ trans('buttons', 'create') }}
	</a>
	<div class="uk-child-width-1-2@s" uk-grid>
        {% set hasPermissionsForView = has_access_permission('admin', 'server', 'view') %}
        {% for server in servers %}
			<div>
				<div class="uk-card uk-card-default">
					<div class="uk-card-header">
						<div class="uk-grid-small uk-flex-middle" uk-grid>
							<div class="uk-width-expand">
								<h3 class="uk-card-title uk-margin-remove-bottom">
									{% if hasPermissionsForView %}
										<a href="{{ path_for('admin_servers_view', {'server': server.id}) }}">{{ server.name }}</a>
									{% else %}
                                        {{ server.name }}
									{% endif %}
								</h3>
								<p class="uk-text-meta uk-margin-remove-top">{{ server.ip }}:{{ server.port }}</p>
							</div>
						</div>
					</div>
					<div class="uk-card-body">
                        {% embed "admin/actions.twig" with {'actionId': server.id} %}
                            {% block actions %}
								<li>
									<a href="{{ path_for('admin_servers_groups_list', {'server': server.id}) }}" class="dropdown-item">
										<span class="uk-margin-small-right" uk-icon="icon: users"></span> &nbsp;{{ trans('admin_servers', 'groups') }}
									</a>
								</li>
								<li>
									<a href="{{ path_for('admin_servers_reasons_list', {'server': server.id}) }}" class="dropdown-item">
										<span class="uk-margin-small-right" uk-icon="icon: bell"></span> &nbsp;{{ trans('admin_servers', 'reasons') }}
									</a>
								</li>
								<li>
									<a href="#tokenModel" data-server-id="{{ server.id }}" uk-toggle>
										<span class="uk-margin-small-right" uk-icon="icon: tag"></span> &nbsp;{{ trans('admin_servers', 'token') }}
									</a>
								</li>
                            {% endblock %}
                        {% endembed %}

                        {{ admin.edit_btn(path_for('admin_servers_edit', {'server': server.id})) }}
                        {{ admin.delete_btn(path_for('admin_servers_delete', {'server': server.id})) }}
					</div>
				</div>
			</div>
        {% endfor %}
	</div>
	{{ paginator.render(pagination) }}
</div>
{% endblock %}

{% block modals %}
    {{ parent() }}
	<div id="tokenModel" uk-modal>
		<div class="uk-modal-dialog uk-modal-body uk-margin-auto-vertical">
			<h2 class="uk-modal-title">{{ trans('admin_servers', 'token') }}</h2>
			<input type="text" class="uk-input" disabled>
			<p class="uk-text-right">
				<button class="uk-button uk-button-default uk-modal-close" type="button">{{ trans('buttons', 'close') }}</button>
			</p>
		</div>
	</div>
{% endblock %}

{% block javascript %}
    {{ parent() }}
	<script>
		$(document).ready(function () {
			$('#tokenModel').on('show', function(e) {
				var serverId = $(e.relatedTarget).data('server-id');
				var modal = $(this);
				$.getJSON('{{ path_for('admin_servers_token') }}', {server: serverId})
					.done(function(data) {
                        if (data.success) {
                            modal.find('.uk-modal-body input').val(data.token);
                        }
					})
                    .fail(function() {
                        console.log("error");
                    });
			});
        });
	</script>
{% endblock %}
