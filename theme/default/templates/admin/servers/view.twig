{% extends 'admin/admin.twig' %}

{% import 'macros/admin.twig' as admin %}

{% block title %}{{ parent() }} | {{ trans('admin_menu', 'servers') }} | {{ server.name }}{% endblock %}

{% block subnav %}
    {% if has_access_permission(
        constants.admin.servers.PERMISSION_GROUP,
        constants.admin.servers.PERMISSION_KEY,
        permissions.ACCESS_LIST
    ) %}
        <div class="uk-float-left">
            {{ admin.back_btn(path_for(constants.admin.servers.ROUTE_LIST), 'l') }}
        </div>
    {% endif %}

    {% if has_access_permission(
        constants.admin.servers.PERMISSION_GROUP,
        constants.admin.servers.PERMISSION_KEY,
        permissions.ACCESS_EDIT
    ) %}
        {{ admin.edit_btn(path_for(constants.admin.servers.ROUTE_EDIT, {'server': server.id}), 'l') }}
    {% endif %}

    {% if has_access_permission(
        constants.admin.servers.PERMISSION_GROUP,
        constants.admin.servers.PERMISSION_KEY,
        permissions.ACCESS_DELETE
    ) %}
        {{ admin.delete_btn(path_for(constants.admin.servers.ROUTE_DELETE, {'server': server.id}), 'l') }}
    {% endif %}

    {% if has_access_resource(
        constants.admin.servers.PERMISSION_TOKEN_GROUP,
        constants.admin.servers.PERMISSION_TOKEN_KEY,
        server.id,
        [permissions.ACCESS_VIEW, permissions.ACCESS_CREATE]
    ) %}
        {{ admin.circle_btn({
            'href': path_for(constants.admin.servers.ROUTE_TOKEN, {'server': server.id}),
            'title': trans('admin_servers', 'token'),
            'icon': 'fas fa-barcode',
            'size': 'l',
            'attrs': {
                'id': 'tokenModalBtn'
            }
        }) }}
    {% endif %}
{% endblock %}

{% block content %}
<div class="uk-card uk-card-default uk-card-body uk-width-1-1@m">
    <div class="uk-card uk-card-secondary uk-grid-collapse uk-child-width-1-2@s uk-margin" uk-grid>
        <div class="uk-card-media-left uk-cover-container">
            {% if server.map.exists() %}
                <img
                    src="{{ base_url() }}/assets/images/maps/{{ server.map.name }}.jpg"
                    alt="{{ server.map.name }}"
                    onerror="this.onerror=null;this.src='{{ base_url() }}/assets/images/blank600x400.png';"
                    class="border-10"
                >
            {% else %}
                <img src="{{ base_url() }}/assets/images/blank600x400.png" alt="" class="border-10">
            {% endif %}
            <div class="uk-overlay-primary uk-position-cover"></div>
            <div class="uk-overlay uk-position-bottom uk-light">
                {{ trans('admin_servers', 'map') }}: {{ server.map.exists() ? server.map.name : '-' }}
                <br>
                {{ trans('admin_servers', 'online') }}: {{ server.num_players }}/{{ server.max_players }}
            </div>
        </div>
        <div>
            <div class="uk-card-body">
                <h3 class="uk-card-title">{{ server.name }}</h3>
                <h5><a href="steam://connect/{{ server.ip }}:{{ server.port }}">{{ server.ip }}:{{ server.port }}</a></h5>
                <div f-table f-divider>
                    <ul>
                        <li>{{ trans('labels', 'created_at') }}</li>
                        <li>{{ server.created_at|date("d/m/Y H:i") }}</li>
                    </ul>
                    <ul>
                        <li>{{ trans('labels', 'updated_at') }}</li>
                        <li>{{ server.updated_at|date("d/m/Y H:i") }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="uk-card-body uk-padding-small">
        {% set hasGroupsPermissions = has_access_resource(
            constants.admin.groups.PERMISSION_GROUP,
            constants.admin.groups.PERMISSION_KEY,
            server.id,
            permissions.ACCESS_LIST
        ) %}

        {% set hasReasonsPermissions = has_access_resource(
            constants.admin.reasons.PERMISSION_GROUP,
            constants.admin.reasons.PERMISSION_KEY,
            server.id,
            permissions.ACCESS_LIST
        ) %}
        {% set hasPlayerViewPermissions = has_access_permission(
            constants.admin.players.PERMISSION_GROUP,
            constants.admin.players.PERMISSION_KEY,
            permissions.ACCESS_VIEW
        ) %}
        <div class="uk-overflow-auto">
            <ul class="uk-flex-left uk-flex-nowrap" uk-tab="connect: #server-info;animation: uk-animation-slide-left-medium, uk-animation-slide-right-medium">
                <li {% if tab == 'online' %}class="uk-active"{% endif %}>
                    <a href="#">{{ trans('admin_servers', 'players_online') }}</a>
                </li>
                {% if hasGroupsPermissions %}
                    <li {% if tab == 'groups' %}class="uk-active"{% endif %}>
                        <a href="#">{{ trans('admin_servers', 'groups') }}</a>
                    </li>
                {% endif %}
                {% if hasReasonsPermissions %}
                    <li {% if tab == 'reasons' %}class="uk-active"{% endif %}>
                        <a href="#">{{ trans('admin_servers', 'reasons') }}</a>
                    </li>
                {% endif %}
                <li>
                    <a href="#">{{ trans('admin_privileges', 'privileges') }}</a>
                </li>
            </ul>
        </div>
        <ul id="server-info" class="uk-switcher uk-margin">
            <li>
                <div class="uk-card uk-card-secondary uk-card-body uk-width-1-1@m">
                    {% set hasPermissionsForView = has_access_permission(
                        constants.admin.players.PERMISSION_GROUP,
                        constants.admin.players.PERMISSION_KEY,
                        premissions.ACCESS_VIEW
                    ) %}
                    <div f-table f-divider>
                        <ul th>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">{{ trans('admin_servers', 'nick') }}</li>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">{{ trans('admin_servers', 'steamid') }}</li>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">{{ trans('admin_servers', 'ip') }}</li>
                            <li class="uk-width-1-6@m uk-width-1-6@s uk-visible@m"></li>
                        </ul>
                        {% for player in players %}
                            <ul>
                                <li class="uk-width-1-4@m uk-width-1-4@s" data-title="Nick">
                                    {% if hasPermissionsForView %}
                                        <a href="{{ path_for(constants.admin.players.ROUTE_LIST) }}">{{ player.nick }}</a>
                                    {% else %}
                                        {{ player.nick }}
                                    {% endif %}
                                </li>
                                <li class="uk-width-1-4@m uk-width-1-4@s" data-title="STEAM ID">{{ player.steamid }}</li>
                                <li class="uk-width-1-4@m uk-width-1-4@s" data-title="IP">{{ player.ip }}</li>
                                <li class="uk-width-1-6@m uk-width-1-6@s">
                                    {% embed "admin/actions.twig" with {'actionId': server.id} %}
                                        {% block actions %}
                                            {% if has_access_resource(
                                                constants.admin.privileges.PERMISSION_GROUP,
                                                constants.admin.privileges.PERMISSION_KEY,
                                                serverId,
                                                permissions.ACCESS_CREATE
                                            ) %}
                                                <li>
                                                    <a
                                                        href="{{ path_for(constants.admin.privileges.ROUTE_CREATE, {
                                                            'player': player.id,
                                                            'server': server.id
                                                        }) }}"
                                                        class="dropdown-item"
                                                    >Create Privilege</a>
                                                </li>
                                            {% endif %}

                                            {% if has_access_resource(
                                                constants.admin.punishments.PERMISSION_GROUP,
                                                constants.admin.punishments.PERMISSION_KEY,
                                                serverId,
                                                permissions.ACCESS_CREATE
                                            ) %}
                                                <li>
                                                    <a
                                                        href="{{ path_for(constants.admin.punishments.ROUTE_CREATE, {
                                                            'player': player.id,
                                                            'server': server.id
                                                        }) }}"
                                                        class="dropdown-item"
                                                    >Punish</a>
                                                </li>
                                            {% endif %}
                                        {% endblock %}
                                    {% endembed %}
                                </li>
                            </ul>
                        {% else %}
                            <ul>
                                <li>{{ trans('admin_servers', 'no_players') }}</li>
                            </ul>
                        {% endfor %}
                    </div>
                </div>
            </li>
            {% if hasGroupsPermissions %}
            <li>
                <div class="uk-card uk-card-default uk-card-body uk-width-1-1@m">
                    <div f-table f-divider>
                        <ul th>
                            <li class="uk-width-1-6@m uk-width-1-6@s uk-visible@s"></li>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">{{ trans('admin_groups', 'group') }}</li>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">{{ trans('admin_groups', 'flags') }}</li>
                            <li class="uk-width-1-6@m uk-width-1-6@s uk-visible@m">
                                {% if has_access_resource(
                                    constants.admin.groups.PERMISSION_GROUP,
                                    constants.admin.groups.PERMISSION_KEY,
                                    server.id,
                                    permissions.ACCESS_CREATE
                                ) %}
                                    {{ admin.add_btn(path_for(constants.admin.groups.ROUTE_CREATE, {'server': server.id}), 's') }}
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                    <div f-table f-divider uk-sortable="handle: .uk-sortable-handle">
                        {% for group in groups %}
                            <ul data-id="{{ group.id }}">
                                <li class="uk-width-1-6@m uk-width-1-6@s" s-title="Priority">
                                    <span class="uk-sortable-handle"><i class="fas fa-sort"></i></span>
                                </li>
                                <li class="uk-width-1-4@m uk-width-1-4@s">{{ group.title }}</li>
                                <li class="uk-width-1-4@m uk-width-1-4@s">{{ get_flags(group.flags) }}</li>
                                <li class="uk-width-1-6@m uk-width-1-6@s">
                                    {% if has_access_resource(
                                        constants.admin.groups.PERMISSION_GROUP,
                                        constants.admin.groups.PERMISSION_KEY,
                                        server.id,
                                        permissions.ACCESS_EDIT
                                    ) %}
                                        {{ admin.edit_btn(
                                            path_for(constants.admin.groups.ROUTE_EDIT, {'server': server.id, 'group': group.id})
                                        ) }}
                                    {% endif %}

                                    {% if has_access_resource(
                                        constants.admin.groups.PERMISSION_GROUP,
                                        constants.admin.groups.PERMISSION_KEY,
                                        server.id,
                                        permissions.ACCESS_DELETE
                                    ) %}
                                        {{ admin.delete_btn(
                                            path_for(constants.admin.groups.ROUTE_DELETE, {'server': server.id, 'group': group.id})
                                        ) }}
                                    {% endif %}
                                </li>
                            </ul>
                        {% endfor %}
                    </div>
                </div>
            </li>
            {% endif %}
            {% if hasReasonsPermissions %}
            <li>
                <div class="uk-card uk-card-default uk-card-body uk-width-1-1@m">
                    <div f-table f-divider>
                        <ul th>
                            <li class="uk-width-1-3@m uk-width-1-3@s uk-visible@s">{{ trans('admin_reasons', 'reason') }}</li>
                            <li class="uk-width-1-3@m uk-width-1-3@s uk-visible@s">{{ trans('admin_reasons', 'time') }}</li>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@m">
                                {% if has_access_resource(
                                    constants.admin.reasons.PERMISSION_GROUP,
                                    constants.admin.reasons.PERMISSION_KEY,
                                    server.id,
                                    permissions.ACCESS_CREATE
                                ) %}
                                    {{ admin.add_btn(path_for(constants.admin.reasons.ROUTE_CREATE, {'server': server.id}), 's') }}
                                {% endif %}
                            </li>
                        </ul>
                        {% for reason in server.reasons %}
                            <ul>
                                <li class="uk-width-1-3@m uk-width-1-3@s" s-title="Title">{{ reason.title }}</li>
                                <li class="uk-width-1-3@m uk-width-1-3@s" s-title="Time">
                                    {% if reason.time is null %}
                                        Not setted
                                    {% else %}
                                        {{ reason.time }} minutes
                                    {% endif %}
                                </li>
                                <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@m">
                                    {% if has_access_resource(
                                        constants.admin.reasons.PERMISSION_GROUP,
                                        constants.admin.reasons.PERMISSION_KEY,
                                        server.id,
                                        permissions.ACCESS_EDIT
                                    ) %}
                                        {{ admin.edit_btn(
                                            path_for(constants.admin.reasons.ROUTE_EDIT, {'server': server.id, 'reason': reason.id})
                                        ) }}
                                    {% endif %}

                                    {% if has_access_resource(
                                        constants.admin.reasons.PERMISSION_GROUP,
                                        constants.admin.reasons.PERMISSION_KEY,
                                        server.id,
                                        permissions.ACCESS_DELETE
                                    ) %}
                                        {{ admin.delete_btn(
                                            path_for(constants.admin.reasons.ROUTE_DELETE, {'server': server.id, 'reason': reason.id})
                                        ) }}
                                    {% endif %}
                                </li>
                            </ul>
                        {% endfor %}
                    </div>
                </div>
            </li>
            {% endif %}
            <li>
                <div class="uk-card uk-card-default uk-card-body uk-width-1-1@m">
                    <div f-table f-divider>
                        <ul th>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">{{ trans('admin_privileges', 'group') }}</li>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">{{ trans('admin_privileges', 'player') }}</li>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">{{ trans('admin_privileges', 'expired') }}</li>
                            <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s"></li>
                        </ul>
                        {% for privilege in privileges %}
                            <ul>
                                <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">
                                    {{ privilege.group.title }}
                                </li>
                                <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">
                                    {% if hasPlayerViewPermissions %}
                                        <a href="{{ path_for(constants.admin.players.ROUTE_VIEW, {'player': privilege.player.id}) }}">
                                            {{ privilege.player.nick }}
                                        </a>
                                    {% else %}
                                        {{ privilege.player.nick }}
                                    {% endif %}
                                </li>
                                <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">
                                    {% if privilege.expired_at is null %}
                                        {{ trans('admin_privileges', 'forever') }}
                                    {% else %}
                                        {{ privilege.expired_at }}
                                    {% endif %}
                                </li>
                                <li class="uk-width-1-4@m uk-width-1-4@s uk-visible@s">
                                    {% if has_access_resource(
                                        constants.admin.privileges.PERMISSION_GROUP,
                                        constants.admin.privileges.PERMISSION_KEY,
                                        server.id,
                                        permissions.ACCESS_EDIT
                                    ) %}
                                        {{ admin.edit_btn(
                                            path_for(constants.admin.privileges.ROUTE_EDIT, {
                                                'player': privilege.player.id,
                                                'privilege' : privilege.id
                                            })
                                        ) }}
                                    {% endif %}

                                    {% if has_access_resource(
                                        constants.admin.privileges.PERMISSION_GROUP,
                                        constants.admin.privileges.PERMISSION_KEY,
                                        server.id,
                                        permissions.ACCESS_DELETE
                                    ) %}
                                        {{ admin.delete_btn(
                                            path_for(constants.admin.privileges.ROUTE_DELETE, {
                                                'player': privilege.player.id,
                                                'privilege' : privilege.id
                                            })
                                        ) }}
                                    {% endif %}
                                </li>
                            </ul>
                        {% else %}
                            <ul>
                                <li>{{ trans('admin_privileges', 'empty_list') }}</li>
                            </ul>
                        {% endfor %}
                    </div>
                </div>
            </li>
        </ul>
    </div>

</div>
{% endblock %}

{% block modals %}
<div id="tokenModalPrompt" uk-modal>
    <div class="uk-modal-dialog uk-modal-body uk-light uk-background-secondary">
        <h2 class="uk-modal-title">{{ trans('labels', 'are_you_sure') }}</h2>
        <p class="uk-text-danger">{{ trans('admin_servers', 'token_warn') }}</p>
        <p class="uk-text-right">
            <button class="uk-button uk-button-default uk-modal-close" type="button">{{ trans('labels', 'no') }}</button>
            <button id="tokenModalConfirmBtn" class="uk-button uk-button-primary" type="button">{{ trans('labels', 'yes') }}</button>
        </p>
    </div>
</div>
<div id="tokenModal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body uk-light uk-background-secondary">
        <h2 class="uk-modal-title">{{ trans("admin_servers", "token") }}</h2>
        <p class="uk-modal-body token"></p>
        <p class="uk-text-right">
            <button class="uk-button uk-button-default uk-modal-close" type="button">{{ trans('buttons', 'close') }}</button>
        </p>
    </div>
</div>
{% endblock %}

{% block javascript %}
    {{ parent() }}
	<script>
	    window.GROUPS_PRIORITY_URL = '{{ path_for(constants.admin.groups.ROUTE_PRIORITY, {'server': server.id}) }}';
		$(document).ready(function () {
		    $('#tokenModalBtn').on('click', function(e) {
		        e.preventDefault();
		        e.stopPropagation();

		        UIkit.modal('#tokenModalPrompt').show();
		    });

		    $('#tokenModalConfirmBtn').on('click', function(e) {
		        e.preventDefault();
		        e.stopPropagation();

		        $.getJSON($('#tokenModalBtn').attr('href'))
		            .done(function(data) {
		                if (data.success) {
		                    $("#tokenModal .uk-modal-body.token").text(data.token);
		                    UIkit.modal('#tokenModal').show();
		                }
		            });
		    });
        });
	</script>
	<script src="{{ base_url() }}/assets/scripts/admin_groups.js"></script>
{% endblock %}
